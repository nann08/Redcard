<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#18181b">
    <meta name="apple-mobile-web-app-title" content="Red Card">
    <meta name="application-name" content="Red Card">

    <!-- App Icons (White Background, Red Card Center) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0id2hpdGUiLz48cmVjdCB4PSIxNDYiIHk9Ijk2IiB3aWR0aD0iMjIwIiBoZWlnaHQ9IjMyMCIgcng9IjMwIiBmaWxsPSIjZWY0NDQ0Ii8+PC9zdmc+">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0id2hpdGUiLz48cmVjdCB4PSIxNDYiIHk9Ijk2IiB3aWR0aD0iMjIwIiBoZWlnaHQ9IjMyMCIgcng9IjMwIiBmaWxsPSIjZWY0NDQ0Ii8+PC9zdmc+">

    <!-- PWA Manifest (Embedded safely) -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiUmVkIENhcmQiLCJzaG9ydF9uYW1lIjoiUmVkIENhcmQiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzE4MTgxYiIsInRoZW1lX2NvbG9yIjoiIzE4MTgxYiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTVMTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZ3lOQ0EwSURVeE1pQTFNVElpUGp4eVpXTjBJRGQ1WkhSb0xUVXhNaUJoWldGbmFIUTlJakV4TWlJZ2ZtbHNiRDBpSTJaZmZtWm1aaUl2UGp4eVpXTjBJSGc5SWpFME5pSWdlVDBpT1RZaUlIZHBaSFJvUFNJeU1qQWlJR2hsYVdkb2RDMHpNakFpSUhKNExTSXpNQ0lpSUdadmJHdzlJaTVsWmpRME5EUWlMMzQ4TDNOMlp6ND0iLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">

    <title>Red Card</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&display=swap" rel="stylesheet">

    <!-- CLEANUP SCRIPT -->
    <script>
        try {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                    }
                }).catch(err => { console.log("SW cleanup skipped"); });
            }
        } catch (e) { console.log("SW not supported"); }
    </script>

    <style>
        /* Core Styling */
        body {
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        /* Transitions */
        #card-display {
            transition: background-color 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }

        #blue-ui {
            transition: opacity 0.3s ease-out, visibility 0.3s linear;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        #blue-ui.active-ui {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transition-delay: 0.1s;
        }

        /* Splash Screen */
        .splash-fade-out {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.7s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.7s;
        }
        
        @keyframes float {
            0% { transform: rotate(-6deg) translateY(0px); }
            50% { transform: rotate(-6deg) translateY(-5px); }
            100% { transform: rotate(-6deg) translateY(0px); }
        }
        .logo-card {
            animation: float 3s ease-in-out infinite;
        }

        /* Fonts & Elements */
        .font-digital {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            text-shadow: 0 0 15px rgba(56, 189, 248, 0.3);
        }

        .scoreboard-cage {
            background-color: #000;
            background-image: 
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 4px 4px;
            box-shadow: inset 0 0 30px rgba(0,0,0,1);
            border: 1px solid #334155;
            position: relative;
            overflow: hidden;
        }
        
        .scoreboard-cage::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 40%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.05), transparent);
            pointer-events: none;
        }

        /* Halftime Popup */
        #halftime-popup {
            position: absolute;
            top: 42%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid #fbbf24;
            color: #fbbf24;
            padding: 0.5rem 1.25rem;
            border-radius: 0.75rem;
            z-index: 60;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
            width: max-content;
            max-width: 180px;
        }
        
        #halftime-popup.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.2); }
            50% { box-shadow: 0 0 40px rgba(251, 191, 36, 0.5); }
        }

        .halftime-active .scoreboard-cage {
            border-color: #fbbf24;
            animation: pulse-gold 2s infinite;
        }
        
        .halftime-active #timer-display {
            color: #fbbf24;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
        }
        
        /* Period Indicator Animation */
        .period-change {
            animation: pulse-text 0.5s ease-in-out;
        }
        @keyframes pulse-text {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Buttons */
        .btn-premium {
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.3), 
                0 2px 4px -1px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.1s ease;
        }
        .btn-premium:active {
            transform: translateY(2px);
            box-shadow: 
                0 1px 2px 0 rgba(0, 0, 0, 0.3),
                inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn-start {
            background: radial-gradient(circle at 30% 30%, #4ade80, #16a34a);
            box-shadow: 0 4px 0 #15803d, 0 5px 10px rgba(0,0,0,0.3);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn-start:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #15803d, 0 2px 4px rgba(0,0,0,0.3);
        }

        .btn-stop {
            background: radial-gradient(circle at 30% 30%, #f87171, #dc2626) !important;
            box-shadow: 0 4px 0 #991b1b, 0 5px 10px rgba(0,0,0,0.3) !important;
        }
        .btn-stop:active {
            transform: translateY(3px) !important;
            box-shadow: 0 1px 0 #991b1b, 0 2px 4px rgba(0,0,0,0.3) !important;
        }

        /* Form Inputs */
        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            outline: none;
            width: 100%;
            font-size: 16px;
            transition: all 0.2s;
        }
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(56, 189, 248, 0.5);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.2);
        }

        /* Light Mode Overrides */
        #blue-ui.light-mode .glass-input {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #1f2937;
        }
        #blue-ui.light-mode .glass-input:focus {
            background: #ffffff;
            border-color: #3b82f6;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
        }
        #blue-ui.light-mode #setup-header h2 { color: #4b5563; }
        #blue-ui.light-mode #setup-timer-display { color: #111827; }
        #blue-ui.light-mode #edit-btn, 
        #blue-ui.light-mode #theme-btn {
            background-color: #e2e8f0;
            border-color: #cbd5e1;
            color: #475569;
        }
        #blue-ui.light-mode .logo-upload-preview {
            border-color: rgba(0,0,0,0.2);
            background-color: rgba(0,0,0,0.05);
        }
        #blue-ui.light-mode .logo-upload-preview i { color: rgba(0,0,0,0.4); }

        .hidden-ui { display: none !important; }

        /* Logo Preview */
        .logo-upload-preview {
            width: 72px; 
            height: 72px; 
            border-radius: 50%; 
            background-color: rgba(255,255,255,0.08);
            border: 2px dashed rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .logo-upload-preview:hover {
            background-color: rgba(255,255,255,0.15);
            border-color: white;
        }
        .logo-upload-preview img { width: 100%; height: 100%; object-fit: cover; }
        
        .scoreboard-logo {
            width: 72px; 
            height: 72px; 
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 8px;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
        }

        /* Goal Button Styles */
        .btn-goal {
            background: rgba(30, 41, 59, 0.8);
            border-width: 2px;
            transition: all 0.15s ease-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-goal:active { transform: scale(0.95); }
        .btn-goal-home { border-color: rgba(59, 130, 246, 0.5); }
        .btn-goal-home:active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
        }
        .btn-goal-away { border-color: rgba(239, 68, 68, 0.5); }
        .btn-goal-away:active {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
        }

        /* Results Screen Styles */
        .winner-card {
            transform: scale(1.15);
            opacity: 1;
            z-index: 10;
        }
        
        /* Removed green border and trophy styles */

        .loser-card {
            transform: scale(0.85);
            opacity: 0.6;
            z-index: 5;
        }
        
        .draw-card {
            transform: scale(1);
            opacity: 1;
        }

        #cropper-modal { touch-action: none; }
    </style>
</head>
<body class="bg-gray-900 h-screen w-screen overflow-hidden flex flex-col font-sans">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 z-[100] bg-white flex items-center justify-center">
        <div class="flex flex-col items-center">
            <div class="logo-card w-16 h-24 bg-red-500 rounded-lg shadow-2xl mb-6 flex items-center justify-center relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-tr from-black/10 to-transparent"></div>
                <div class="absolute top-0 right-0 w-full h-full bg-gradient-to-bl from-white/20 to-transparent"></div>
            </div>
            <h1 class="text-3xl font-semibold text-gray-900 tracking-tight">Red Card</h1>
        </div>
    </div>

    <!-- Image Cropper -->
    <div id="cropper-modal" class="fixed inset-0 z-[200] bg-black flex flex-col hidden-ui" onclick="stopProp(event)">
        <div class="flex justify-between items-center px-4 pb-4 pt-[calc(env(safe-area-inset-top)+1rem)] bg-gray-900 border-b border-gray-800 z-10">
            <button onclick="cancelCrop()" class="text-white text-base font-medium px-2 py-1">Cancel</button>
            <h3 class="text-white font-bold text-sm tracking-wide">ADJUST IMAGE</h3>
            <button onclick="saveCrop()" class="text-blue-400 font-bold text-base px-2 py-1">Done</button>
        </div>
        <div class="flex-1 relative bg-neutral-900 overflow-hidden flex items-center justify-center touch-none" id="cropper-container">
            <canvas id="cropper-canvas" class="z-0"></canvas>
            <div id="cropper-overlay" class="absolute pointer-events-none border-[9999px] border-black/60 z-10 box-content"></div>
            <div id="cropper-grid" class="absolute pointer-events-none border border-white/30 z-20">
                <div class="absolute top-1/3 w-full h-px bg-white/20"></div>
                <div class="absolute top-2/3 w-full h-px bg-white/20"></div>
                <div class="absolute left-1/3 h-full w-px bg-white/20"></div>
                <div class="absolute left-2/3 h-full w-px bg-white/20"></div>
            </div>
        </div>
        <div class="h-12 pb-[env(safe-area-inset-bottom)] box-content bg-gray-900 border-t border-gray-800 flex items-center justify-center text-xs text-gray-400">Pinch to Zoom â€¢ Drag to Move</div>
    </div>

    <!-- Main Card Area -->
    <div id="card-display" class="flex-1 w-full relative cursor-pointer active:brightness-95 bg-red-600 flex flex-col items-center justify-center">
        
        <!-- BLUE UI CONTAINER -->
        <div id="blue-ui" class="absolute inset-0 w-full h-full px-6 pb-6 pt-[calc(env(safe-area-inset-top)+1.5rem)] flex flex-col">
            
            <!-- Header -->
            <div class="flex justify-between items-start w-full mb-4 relative z-20">
                <div class="flex flex-col gap-3">
                    <button id="edit-btn" class="w-10 h-10 bg-slate-800 rounded-full flex items-center justify-center btn-premium border border-slate-700 text-slate-300 hover:text-white" onclick="toggleEditMode(event)">
                        <i data-lucide="pencil" class="w-4 h-4"></i>
                    </button>
                    <button id="theme-btn" class="w-10 h-10 bg-slate-800 rounded-full flex items-center justify-center btn-premium border border-slate-700 text-slate-300 hover:text-white" onclick="toggleTheme(event)">
                        <i data-lucide="moon" class="w-4 h-4"></i>
                    </button>
                </div>
                
                <div id="setup-header" class="absolute left-1/2 top-3 -translate-x-1/2 flex flex-col items-center justify-center pointer-events-none">
                    <h2 class="text-white/50 text-sm font-bold tracking-widest uppercase transition-colors">Match Setup</h2>
                    <div id="setup-timer-display" class="font-digital text-white text-xl tracking-wider leading-none mt-1 hidden-ui transition-colors">00:00</div>
                </div>

                <button id="confirm-btn" class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center btn-premium text-white" onclick="lockSettings(event)">
                    <i data-lucide="check" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Setup Form -->
            <div id="setup-view" class="flex-1 flex flex-col justify-center space-y-8 max-w-sm mx-auto w-full z-10" onclick="stopProp(event)">
                <!-- Team 1 -->
                <div class="flex items-center gap-4">
                    <div class="relative group">
                        <div class="logo-upload-preview" onclick="triggerUpload(1)">
                            <img id="preview-logo-1" class="hidden" src="" alt="Team 1">
                            <i data-lucide="plus" id="icon-logo-1" class="w-8 h-8 text-white/50"></i>
                        </div>
                        <button id="remove-logo-1" class="hidden absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-1 shadow-lg hover:bg-red-600 transition-colors z-20" onclick="removeLogo(event, 1)">
                            <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                    </div>
                    <div class="flex-1 space-y-1">
                        <div class="flex justify-between px-1">
                            <label class="text-blue-400 text-xs font-bold tracking-wider uppercase">Home Team</label>
                            <label class="text-blue-400 text-xs font-bold tracking-wider uppercase">Score</label>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="team1-input" class="glass-input flex-1" placeholder="Name" value="Home">
                            <input type="number" id="team1-score-input" class="glass-input w-20 text-center font-digital text-lg" value="0">
                        </div>
                    </div>
                </div>

                <!-- Team 2 -->
                <div class="flex items-center gap-4">
                    <div class="relative group">
                        <div class="logo-upload-preview" onclick="triggerUpload(2)">
                            <img id="preview-logo-2" class="hidden" src="" alt="Team 2">
                            <i data-lucide="plus" id="icon-logo-2" class="w-8 h-8 text-white/50"></i>
                        </div>
                        <button id="remove-logo-2" class="hidden absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-1 shadow-lg hover:bg-red-600 transition-colors z-20" onclick="removeLogo(event, 2)">
                            <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                    </div>
                    <div class="flex-1 space-y-1">
                        <div class="flex justify-between px-1">
                            <label class="text-red-400 text-xs font-bold tracking-wider uppercase">Away Team</label>
                            <label class="text-red-400 text-xs font-bold tracking-wider uppercase">Score</label>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="team2-input" class="glass-input flex-1" placeholder="Name" value="Away">
                            <input type="number" id="team2-score-input" class="glass-input w-20 text-center font-digital text-lg" value="0">
                        </div>
                    </div>
                </div>
                
                <input type="file" id="file-input-1" class="hidden" accept="image/*" onchange="handleFileSelect(event, 1)">
                <input type="file" id="file-input-2" class="hidden" accept="image/*" onchange="handleFileSelect(event, 2)">

                <div class="h-px bg-white/10 w-full my-2 transition-colors duration-300"></div>
                
                <!-- Time Inputs -->
                <div class="flex gap-4">
                    <div class="flex-1 space-y-2">
                        <label class="text-slate-400 text-xs font-bold tracking-wider uppercase ml-1">Match Duration</label>
                        <div class="relative">
                            <input type="number" step="0.5" id="match-time-input" class="glass-input text-center font-digital text-xl" placeholder="90" value="90">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-white/30 text-xs pointer-events-none">min</span>
                        </div>
                    </div>
                    <div class="flex-1 space-y-2">
                        <label class="text-slate-400 text-xs font-bold tracking-wider uppercase ml-1">Half Time</label>
                        <div class="relative">
                            <input type="number" step="0.5" id="half-time-input" class="glass-input text-center font-digital text-xl" placeholder="15" value="15">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-white/30 text-xs pointer-events-none">min</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game View -->
            <div id="game-view" class="flex-1 flex flex-col hidden-ui z-10 space-y-6">
                
                <div class="scoreboard-cage rounded-2xl p-6 flex flex-col items-center justify-center shadow-2xl border-2 border-slate-700 bg-black transition-colors duration-500" onclick="stopProp(event)">
                    
                    <!-- Halftime Popup -->
                    <div id="halftime-popup" class="flex flex-col items-center">
                        <div class="text-xl font-black italic tracking-widest uppercase whitespace-nowrap">Half Time</div>
                    </div>

                    <div class="flex justify-between items-start w-full mb-4">
                        <div class="text-center flex-1 flex flex-col items-center">
                            <img id="score-logo-1" class="scoreboard-logo hidden" src="">
                            <div id="score-team1-name" class="text-blue-400 text-sm font-black tracking-wider uppercase mb-1 truncate px-1 max-w-[120px]">Home</div>
                            <div id="score-team1-val" class="font-digital text-5xl text-blue-400 leading-none mt-1">0</div>
                        </div>
                        <div class="h-16 w-px bg-slate-800 mx-2 mt-4"></div>
                        <div class="text-center flex-1 flex flex-col items-center">
                            <img id="score-logo-2" class="scoreboard-logo hidden" src="">
                            <div id="score-team2-name" class="text-red-400 text-sm font-black tracking-wider uppercase mb-1 truncate px-1 max-w-[120px]">Away</div>
                            <div id="score-team2-val" class="font-digital text-5xl text-red-400 leading-none mt-1">0</div>
                        </div>
                    </div>

                    <div class="w-full h-px bg-slate-800 mb-4 transition-colors duration-500"></div>
                    
                    <!-- Period Indicator -->
                    <div id="period-display" class="text-xs font-bold text-slate-500 tracking-[0.2em] mb-1 transition-all duration-300">PERIOD 1</div>
                    
                    <div id="timer-display" class="font-digital text-6xl text-white tracking-widest tabular-nums leading-none font-bold transition-colors duration-500">00:00</div>
                </div>

                <div class="flex justify-center py-2" onclick="stopProp(event)">
                    <button id="go-btn" class="w-20 h-20 rounded-full btn-start flex items-center justify-center transition-all text-white font-black text-xl tracking-widest" onclick="toggleTimer(event)">GO</button>
                </div>

                <div class="grid grid-cols-2 gap-4 mt-auto" onclick="stopProp(event)">
                    <button class="btn-goal btn-goal-home rounded-2xl h-24 flex flex-col items-center justify-center backdrop-blur-sm" onclick="addGoal(1)">
                        <span class="text-white text-base font-bold tracking-widest mb-1">GOAL</span>
                        <span id="btn-team1-name" class="text-blue-400 text-sm font-medium truncate max-w-[90%] opacity-80">Home</span>
                    </button>
                    <button class="btn-goal btn-goal-away rounded-2xl h-24 flex flex-col items-center justify-center backdrop-blur-sm" onclick="addGoal(2)">
                        <span class="text-white text-base font-bold tracking-widest mb-1">GOAL</span>
                        <span id="btn-team2-name" class="text-red-400 text-sm font-medium truncate max-w-[90%] opacity-80">Away</span>
                    </button>
                </div>

            </div>

            <!-- Results View -->
            <div id="results-view" class="absolute inset-0 z-50 flex flex-col items-center justify-center hidden-ui bg-black/80 backdrop-blur-md p-6" onclick="stopProp(event)">
                <h1 id="result-title" class="text-4xl font-black text-white italic tracking-widest uppercase text-center drop-shadow-[0_0_15px_rgba(255,255,255,0.5)] mb-10 animate-bounce">HOME WINS</h1>
                
                <div class="flex items-center justify-center gap-2 w-full mb-12">
                    <!-- Team 1 Result -->
                    <div id="result-card-1" class="flex flex-col items-center transition-all duration-700 ease-in-out">
                        <div class="relative mb-4">
                            <img id="result-logo-1" src="" class="w-24 h-24 rounded-full object-cover border-4 border-transparent shadow-2xl bg-gray-800">
                        </div>
                        <h2 id="result-name-1" class="text-lg font-bold text-blue-400 uppercase tracking-wider mb-2 max-w-[120px] truncate">Home</h2>
                        <div id="result-score-1" class="font-digital text-6xl text-white leading-none">2</div>
                    </div>

                    <div class="text-slate-600 font-black text-2xl px-2 italic">VS</div>

                    <!-- Team 2 Result -->
                    <div id="result-card-2" class="flex flex-col items-center transition-all duration-700 ease-in-out">
                        <div class="relative mb-4">
                            <img id="result-logo-2" src="" class="w-24 h-24 rounded-full object-cover border-4 border-transparent shadow-2xl bg-gray-800">
                        </div>
                        <h2 id="result-name-2" class="text-lg font-bold text-red-400 uppercase tracking-wider mb-2 max-w-[120px] truncate">Away</h2>
                        <div id="result-score-2" class="font-digital text-6xl text-white leading-none">1</div>
                    </div>
                </div>

                <button onclick="resetGame()" class="group relative px-8 py-4 bg-white text-black font-black text-xl rounded-full uppercase tracking-widest shadow-[0_0_20px_rgba(255,255,255,0.3)] hover:scale-105 active:scale-95 transition-all overflow-hidden">
                    <span class="relative z-10">New Match</span>
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/50 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite]"></div>
                </button>
            </div>

        </div>
    </div>

    <script>
        lucide.createIcons();

        let currentAudioContext = null;
        let isDarkMode = true;
        
        const cardDisplay = document.getElementById('card-display');
        const splashScreen = document.getElementById('splash-screen');
        const blueUi = document.getElementById('blue-ui');
        const halftimePopup = document.getElementById('halftime-popup');
        const resultsView = document.getElementById('results-view');

        const getCards = () => ['bg-red-600', 'bg-yellow-400', isDarkMode ? 'bg-zinc-900' : 'bg-gray-100'];
        let currentCardIndex = 2;

        let gameSettings = { team1: "Home", team2: "Away", team1Logo: null, team2Logo: null, matchTime: 90, halfTime: 15, locked: false };
        let gameState = { 
            team1Score: 0, 
            team2Score: 0, 
            timeRemaining: 45 * 60, 
            isRunning: false, 
            timerInterval: null,
            isHalftime: false,
            currentPeriod: 1, // 1 = 1st Half, 2 = 2nd Half, 3 = End
            halfLength: 45 * 60
        };

        const setupView = document.getElementById('setup-view');
        const gameView = document.getElementById('game-view');
        const confirmBtn = document.getElementById('confirm-btn');
        const setupHeader = document.getElementById('setup-header');
        const setupTimerDisplay = document.getElementById('setup-timer-display');
        const timerDisplay = document.getElementById('timer-display');
        const periodDisplay = document.getElementById('period-display');
        const goBtn = document.getElementById('go-btn');
        const themeBtn = document.getElementById('theme-btn');

        window.onload = () => {
            setTimeout(() => { 
                splashScreen.classList.add('splash-fade-out'); 
                setTimeout(() => splashScreen.style.display = 'none', 1000); 
            }, 1500);
            updateCardDisplay();
            updateUI();
        };

        function stopProp(e) { e.stopPropagation(); }
        
        function toggleTheme(e) {
            if(e) e.stopPropagation();
            isDarkMode = !isDarkMode;
            if(isDarkMode) {
                blueUi.classList.remove('light-mode');
                themeBtn.innerHTML = '<i data-lucide="moon" class="w-4 h-4"></i>';
            } else {
                blueUi.classList.add('light-mode');
                themeBtn.innerHTML = '<i data-lucide="sun" class="w-4 h-4"></i>';
            }
            lucide.createIcons();
            updateCardDisplay();
        }

        const cropperModal = document.getElementById('cropper-modal');
        const cropperCanvas = document.getElementById('cropper-canvas');
        const cropperOverlay = document.getElementById('cropper-overlay');
        const cropperGrid = document.getElementById('cropper-grid');
        let cropperCtx = cropperCanvas.getContext('2d');
        
        let cropState = { img: null, currentTeam: null, viewW: 0, viewH: 0, x: 0, y: 0, scale: 1, minScale: 1, boxSize: 0, boxX: 0, boxY: 0, isDragging: false, lastTouchX: 0, lastTouchY: 0, initialPinchDist: 0, initialScale: 1 };

        function triggerUpload(team) { document.getElementById(`file-input-${team}`).click(); }

        function removeLogo(e, team) {
            e.stopPropagation();
            if (team === 1) gameSettings.team1Logo = null; else gameSettings.team2Logo = null;
            const img = document.getElementById(`preview-logo-${team}`);
            const icon = document.getElementById(`icon-logo-${team}`);
            const removeBtn = document.getElementById(`remove-logo-${team}`);
            img.src = ''; img.classList.add('hidden');
            icon.classList.remove('hidden'); removeBtn.classList.add('hidden');
            const scoreImg = document.getElementById(`score-logo-${team}`);
            scoreImg.src = ''; scoreImg.classList.add('hidden');
            document.getElementById(`file-input-${team}`).value = '';
        }

        function handleFileSelect(e, team) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) { const img = new Image(); img.onload = () => initCropper(img, team); img.src = evt.target.result; };
                reader.readAsDataURL(file);
            }
            e.target.value = ''; 
        }

        function initCropper(img, team) {
            cropState.img = img; cropState.currentTeam = team;
            cropperModal.classList.remove('hidden-ui');
            const container = document.getElementById('cropper-container');
            cropState.viewW = container.clientWidth; cropState.viewH = container.clientHeight;
            const dpr = window.devicePixelRatio || 1;
            cropperCanvas.width = cropState.viewW * dpr; cropperCanvas.height = cropState.viewH * dpr;
            cropperCtx.scale(dpr, dpr);
            cropperCanvas.style.width = cropState.viewW + 'px'; cropperCanvas.style.height = cropState.viewH + 'px';
            cropState.boxSize = Math.min(cropState.viewW, cropState.viewH) * 0.8;
            cropState.boxX = (cropState.viewW - cropState.boxSize) / 2; cropState.boxY = (cropState.viewH - cropState.boxSize) / 2;
            cropperOverlay.style.width = cropState.boxSize + 'px'; cropperOverlay.style.height = cropState.boxSize + 'px';
            cropperOverlay.style.left = cropState.boxX + 'px'; cropperOverlay.style.top = cropState.boxY + 'px';
            cropperGrid.style.width = cropState.boxSize + 'px'; cropperGrid.style.height = cropState.boxSize + 'px';
            cropperGrid.style.left = cropState.boxX + 'px'; cropperGrid.style.top = cropState.boxY + 'px';
            const scaleW = cropState.boxSize / img.width; const scaleH = cropState.boxSize / img.height;
            cropState.minScale = Math.max(scaleW, scaleH); cropState.scale = cropState.minScale;
            cropState.x = cropState.boxX + (cropState.boxSize - img.width * cropState.scale) / 2;
            cropState.y = cropState.boxY + (cropState.boxSize - img.height * cropState.scale) / 2;
            requestAnimationFrame(drawCropper);
        }

        function cancelCrop() { cropperModal.classList.add('hidden-ui'); cropState.img = null; }

        function saveCrop() {
            if (!cropState.img) return;
            const srcX = (cropState.boxX - cropState.x) / cropState.scale;
            const srcY = (cropState.boxY - cropState.y) / cropState.scale;
            const srcSize = cropState.boxSize / cropState.scale; 
            const outputCanvas = document.createElement('canvas');
            const outputSize = 512; outputCanvas.width = outputSize; outputCanvas.height = outputSize;
            const ctx = outputCanvas.getContext('2d');
            ctx.drawImage(cropState.img, srcX, srcY, srcSize, srcSize, 0, 0, outputSize, outputSize);
            const resultUrl = outputCanvas.toDataURL('image/png', 0.9);
            applyLogo(cropState.currentTeam, resultUrl);
            cancelCrop();
        }

        function applyLogo(team, dataUrl) {
            if (team === 1) gameSettings.team1Logo = dataUrl; else gameSettings.team2Logo = dataUrl;
            const img = document.getElementById(`preview-logo-${team}`);
            const icon = document.getElementById(`icon-logo-${team}`);
            const removeBtn = document.getElementById(`remove-logo-${team}`);
            img.src = dataUrl; img.classList.remove('hidden');
            icon.classList.add('hidden'); removeBtn.classList.remove('hidden');
            const scoreImg = document.getElementById(`score-logo-${team}`);
            scoreImg.src = dataUrl; scoreImg.classList.remove('hidden');
        }

        function drawCropper() {
            if (!cropState.img) return;
            cropperCtx.clearRect(0, 0, cropState.viewW, cropState.viewH);
            cropperCtx.drawImage(cropState.img, cropState.x, cropState.y, cropState.img.width * cropState.scale, cropState.img.height * cropState.scale);
        }
        
        function getDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX; const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function constrain() {
            const imgW = cropState.img.width * cropState.scale; const imgH = cropState.img.height * cropState.scale;
            const boxRight = cropState.boxX + cropState.boxSize; const boxBottom = cropState.boxY + cropState.boxSize;
            if (cropState.x > cropState.boxX) cropState.x = cropState.boxX;
            if (cropState.y > cropState.boxY) cropState.y = cropState.boxY;
            if (cropState.x + imgW < boxRight) cropState.x = boxRight - imgW;
            if (cropState.y + imgH < boxBottom) cropState.y = boxBottom - imgH;
        }

        const container = document.getElementById('cropper-container');
        container.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) { cropState.isDragging = true; cropState.lastTouchX = e.touches[0].clientX; cropState.lastTouchY = e.touches[0].clientY; } 
            else if (e.touches.length === 2) { cropState.isDragging = false; cropState.initialPinchDist = getDistance(e.touches); cropState.initialScale = cropState.scale; }
        });
        container.addEventListener('touchmove', (e) => {
            e.preventDefault(); if (!cropState.img) return;
            if (e.touches.length === 1 && cropState.isDragging) {
                const dx = e.touches[0].clientX - cropState.lastTouchX; const dy = e.touches[0].clientY - cropState.lastTouchY;
                cropState.x += dx; cropState.y += dy;
                cropState.lastTouchX = e.touches[0].clientX; cropState.lastTouchY = e.touches[0].clientY;
                constrain(); requestAnimationFrame(drawCropper);
            } else if (e.touches.length === 2) {
                const dist = getDistance(e.touches); const zoomFactor = dist / cropState.initialPinchDist; const newScale = cropState.initialScale * zoomFactor;
                if (newScale >= cropState.minScale) {
                    const centerX = (cropState.viewW/2 - cropState.x) / cropState.scale; const centerY = (cropState.viewH/2 - cropState.y) / cropState.scale;
                    cropState.scale = newScale;
                    cropState.x = cropState.viewW/2 - (centerX * newScale); cropState.y = cropState.viewH/2 - (centerY * newScale);
                    constrain(); requestAnimationFrame(drawCropper);
                }
            }
        });
        container.addEventListener('touchend', () => { cropState.isDragging = false; });
        container.addEventListener('mousedown', (e) => { cropState.isDragging = true; cropState.lastTouchX = e.clientX; cropState.lastTouchY = e.clientY; });
        window.addEventListener('mousemove', (e) => {
            if (cropState.isDragging && cropState.img) {
                const dx = e.clientX - cropState.lastTouchX; const dy = e.clientY - cropState.lastTouchY;
                cropState.x += dx; cropState.y += dy;
                cropState.lastTouchX = e.clientX; cropState.lastTouchY = e.clientY;
                constrain(); requestAnimationFrame(drawCropper);
            }
        });
        window.addEventListener('mouseup', () => cropState.isDragging = false);
        container.addEventListener('wheel', (e) => {
            e.preventDefault(); if(!cropState.img) return;
            const zoomChange = -e.deltaY * 0.001; const newScale = cropState.scale * (1 + zoomChange);
            if (newScale >= cropState.minScale) {
                const centerX = (cropState.viewW/2 - cropState.x) / cropState.scale; const centerY = (cropState.viewH/2 - cropState.y) / cropState.scale;
                cropState.scale = newScale;
                cropState.x = cropState.viewW/2 - (centerX * newScale); cropState.y = cropState.viewH/2 - (centerY * newScale);
                constrain(); requestAnimationFrame(drawCropper);
            }
        });

        function lockSettings(e) {
            if(e) e.stopPropagation();
            gameSettings.team1 = document.getElementById('team1-input').value || "Home";
            gameSettings.team2 = document.getElementById('team2-input').value || "Away";
            const inputMatchTime = parseFloat(document.getElementById('match-time-input').value) || 90;
            const inputHalfTime = parseFloat(document.getElementById('half-time-input').value) || 15;
            
            gameState.team1Score = parseInt(document.getElementById('team1-score-input').value) || 0;
            gameState.team2Score = parseInt(document.getElementById('team2-score-input').value) || 0;
            
            // If settings are unlocked, or time changed, reset the game state basics
            if (inputMatchTime !== gameSettings.matchTime || !gameSettings.locked) {
                // Calculate length of one half (Input is TOTAL duration)
                gameState.halfLength = Math.floor((inputMatchTime / 2) * 60);
                
                // Only reset time if we aren't in the middle of a specific paused state we want to keep
                // For simplicity, unlocking settings resets the current period timer
                gameState.timeRemaining = gameState.halfLength;
                gameState.currentPeriod = 1;
                gameState.isHalftime = false;
                
                halftimePopup.classList.remove('active');
                gameView.classList.remove('halftime-active');
                updatePeriodDisplay();
            }
            
            // Check if Halftime Duration changed WHILE in halftime
            if (gameState.isHalftime && inputHalfTime !== gameSettings.halfTime) {
                gameState.timeRemaining = Math.floor(inputHalfTime * 60);
                updateTimerDisplay();
            }
            
            gameSettings.matchTime = inputMatchTime;
            gameSettings.halfTime = inputHalfTime;
            
            gameSettings.locked = true;
            document.getElementById('score-team1-name').innerText = gameSettings.team1;
            document.getElementById('score-team2-name').innerText = gameSettings.team2;
            document.getElementById('btn-team1-name').innerText = gameSettings.team1;
            document.getElementById('btn-team2-name').innerText = gameSettings.team2;
            document.getElementById('score-team1-val').innerText = gameState.team1Score;
            document.getElementById('score-team2-val').innerText = gameState.team2Score;
            updateTimerDisplay(); updateUI();
        }

        function toggleEditMode(e) {
            if(e) e.stopPropagation();
            document.getElementById('team1-score-input').value = gameState.team1Score;
            document.getElementById('team2-score-input').value = gameState.team2Score;
            document.getElementById('team1-input').value = gameSettings.team1;
            document.getElementById('team2-input').value = gameSettings.team2;
            document.getElementById('match-time-input').value = gameSettings.matchTime;
            document.getElementById('half-time-input').value = gameSettings.halfTime;
            gameSettings.locked = false; updateUI();
        }

        function updatePeriodDisplay() {
            periodDisplay.classList.remove('period-change');
            void periodDisplay.offsetWidth; // Trigger reflow
            periodDisplay.classList.add('period-change');

            if (gameState.isHalftime) {
                periodDisplay.innerText = "HALF TIME";
                periodDisplay.classList.add('text-amber-400');
                periodDisplay.classList.remove('text-slate-500');
            } else {
                periodDisplay.classList.remove('text-amber-400');
                periodDisplay.classList.add('text-slate-500');
                if (gameState.currentPeriod === 1) periodDisplay.innerText = "PERIOD 1";
                else if (gameState.currentPeriod === 2) periodDisplay.innerText = "PERIOD 2";
                else periodDisplay.innerText = "FULL TIME";
            }
        }

        function startHalftime() {
            gameState.isHalftime = true;
            gameState.timeRemaining = Math.floor(gameSettings.halfTime * 60);
            
            halftimePopup.classList.add('active');
            gameView.classList.add('halftime-active');
            updatePeriodDisplay();
            playWhistle();
        }

        function endHalftime() {
            gameState.isHalftime = false;
            gameState.currentPeriod = 2;
            // Reset timer for 2nd half
            gameState.timeRemaining = gameState.halfLength;
            
            halftimePopup.classList.remove('active');
            gameView.classList.remove('halftime-active');
            updatePeriodDisplay();
            updateTimerDisplay(); // Update immediately so we see the time reset
            
            // PREVIOUSLY: toggleTimer(null); // This paused the game
            // NOW: We let it run automatically
            playWhistle();
        }

        function toggleTimer(e) {
            if(e) e.stopPropagation();
            if (gameState.isRunning) {
                clearInterval(gameState.timerInterval); gameState.isRunning = false;
                goBtn.classList.remove('btn-stop'); goBtn.classList.add('btn-start'); 
                goBtn.innerText = "GO";
            } else {
                gameState.isRunning = true;
                goBtn.classList.remove('btn-start'); goBtn.classList.add('btn-stop'); goBtn.innerText = "STOP";
                
                gameState.timerInterval = setInterval(() => {
                    if (gameState.timeRemaining > 0) {
                        gameState.timeRemaining--;
                        updateTimerDisplay();
                    } else {
                        // Time hit 0
                        if (gameState.isRunning) {
                            if (gameState.currentPeriod === 1 && !gameState.isHalftime) {
                                // End of 1st Half -> Start Halftime
                                startHalftime();
                            } else if (gameState.isHalftime) {
                                // End of Halftime -> Start 2nd Half (Paused)
                                endHalftime();
                            } else if (gameState.currentPeriod === 2) {
                                // End of 2nd Half -> Game Over
                                clearInterval(gameState.timerInterval);
                                gameState.isRunning = false;
                                gameState.currentPeriod = 3; // Finished
                                updatePeriodDisplay();
                                playWhistle();
                                setTimeout(() => { playWhistle(); }, 800); // Double whistle for end
                                setTimeout(() => { showResults(); }, 1500); // Delay results slightly
                            }
                        }
                    }
                }, 1000);
            }
            updateUI(); 
        }

        function updateTimerDisplay() {
            const m = Math.floor(gameState.timeRemaining / 60); const s = gameState.timeRemaining % 60;
            const timeString = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            timerDisplay.innerText = timeString; setupTimerDisplay.innerText = timeString;
        }

        function addGoal(team) {
            if (team === 1) { gameState.team1Score++; document.getElementById('score-team1-val').innerText = gameState.team1Score; } 
            else { gameState.team2Score++; document.getElementById('score-team2-val').innerText = gameState.team2Score; }
        }

        function updateUI() {
            if (gameSettings.locked) {
                setupView.classList.add('hidden-ui'); 
                setupHeader.classList.add('hidden-ui'); 
                confirmBtn.classList.add('hidden-ui'); 
                
                if (gameState.currentPeriod === 3) {
                    gameView.classList.add('hidden-ui');
                    resultsView.classList.remove('hidden-ui');
                } else {
                    gameView.classList.remove('hidden-ui');
                    resultsView.classList.add('hidden-ui');
                }
            } else {
                setupView.classList.remove('hidden-ui'); setupHeader.classList.remove('hidden-ui'); confirmBtn.classList.remove('hidden-ui'); gameView.classList.add('hidden-ui'); resultsView.classList.add('hidden-ui');
                if (gameState.isRunning) setupTimerDisplay.classList.remove('hidden-ui'); else setupTimerDisplay.classList.add('hidden-ui');
            }
        }

        function showResults() {
            // Populate Data
            document.getElementById('result-name-1').innerText = gameSettings.team1;
            document.getElementById('result-name-2').innerText = gameSettings.team2;
            document.getElementById('result-score-1').innerText = gameState.team1Score;
            document.getElementById('result-score-2').innerText = gameState.team2Score;
            
            // Handle Logos (use placeholder if empty)
            const logo1 = document.getElementById('result-logo-1');
            const logo2 = document.getElementById('result-logo-2');
            
            // We reuse the preview/uploaded logic or fallback to a colored circle logic? 
            // Better to use the src from the scoreboard images or the base64 stored.
            logo1.src = gameSettings.team1Logo || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2360a5fa' stroke-width='2'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3C/svg%3E";
            logo2.src = gameSettings.team2Logo || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23f87171' stroke-width='2'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3C/svg%3E";

            // Determine Winner
            const card1 = document.getElementById('result-card-1');
            const card2 = document.getElementById('result-card-2');
            const title = document.getElementById('result-title');
            
            // Reset Classes
            card1.classList.remove('winner-card', 'loser-card', 'draw-card');
            card2.classList.remove('winner-card', 'loser-card', 'draw-card');

            if (gameState.team1Score > gameState.team2Score) {
                title.innerText = `${gameSettings.team1} WINS!`;
                title.style.color = '#60a5fa'; // Blue
                card1.classList.add('winner-card');
                card2.classList.add('loser-card');
            } else if (gameState.team2Score > gameState.team1Score) {
                title.innerText = `${gameSettings.team2} WINS!`;
                title.style.color = '#f87171'; // Red
                card2.classList.add('winner-card');
                card1.classList.add('loser-card');
            } else {
                title.innerText = "DRAW";
                title.style.color = '#fbbf24'; // Gold
                card1.classList.add('draw-card');
                card2.classList.add('draw-card');
            }
            
            lucide.createIcons(); // Refresh icons for trophy
            updateUI();
        }

        function resetGame() {
            // Unlock settings and reset basic state
            gameSettings.locked = false;
            gameState.team1Score = 0;
            gameState.team2Score = 0;
            gameState.currentPeriod = 1;
            gameState.isHalftime = false;
            gameState.isRunning = false;
            gameState.timeRemaining = gameState.halfLength;
            
            // Reset inputs
            document.getElementById('team1-score-input').value = 0;
            document.getElementById('team2-score-input').value = 0;
            
            // Reset Scoreboard UI
            document.getElementById('score-team1-val').innerText = 0;
            document.getElementById('score-team2-val').innerText = 0;
            
            goBtn.classList.remove('btn-stop'); goBtn.classList.add('btn-start'); 
            goBtn.innerText = "GO";
            
            updatePeriodDisplay();
            updateTimerDisplay();
            updateUI();
        }

        function updateCardDisplay() {
            const cards = getCards();
            cardDisplay.classList.remove('bg-red-600', 'bg-yellow-400', 'bg-zinc-900', 'bg-gray-100');
            cardDisplay.classList.add(cards[currentCardIndex]);
            if (currentCardIndex === 2) blueUi.classList.add('active-ui'); else blueUi.classList.remove('active-ui');
        }

        function cycleCard(direction) {
            const cards = getCards(); currentCardIndex = (currentCardIndex + direction + cards.length) % cards.length;
            updateCardDisplay();
        }

        function initAudio() {
            if (!currentAudioContext) { currentAudioContext = new (window.AudioContext || window.webkitAudioContext)(); }
            if (currentAudioContext.state === 'suspended') { currentAudioContext.resume(); }
        }

        let activeNodes = []; 
        function playWhistle() {
            initAudio();
            if (activeNodes.length > 0) { activeNodes.forEach(node => { try { node.stop(); } catch(e) {} try { node.disconnect(); } catch(e) {} }); activeNodes = []; }
            const ctx = currentAudioContext; const t = ctx.currentTime; const duration = 2.0; 
            const osc = ctx.createOscillator(); const gainNode = ctx.createGain(); const modulator = ctx.createOscillator(); const modGain = ctx.createGain();
            activeNodes.push(osc); activeNodes.push(modulator);
            osc.type = 'sine'; osc.frequency.setValueAtTime(2000, t); osc.frequency.setValueAtTime(2000, t + duration);
            modulator.type = 'sine'; modulator.frequency.setValueAtTime(50, t); modGain.gain.setValueAtTime(150, t); 
            gainNode.gain.setValueAtTime(0, t); gainNode.gain.linearRampToValueAtTime(0.3, t + 0.1); gainNode.gain.setValueAtTime(0.3, t + duration - 0.2); gainNode.gain.linearRampToValueAtTime(0, t + duration); 
            modulator.connect(modGain); modGain.connect(osc.frequency); osc.connect(gainNode); gainNode.connect(ctx.destination);
            osc.start(t); modulator.start(t); osc.stop(t + duration); modulator.stop(t + duration);
            osc.onended = () => { const index = activeNodes.indexOf(osc); if (index > -1) activeNodes.splice(index, 1); };
        }

        let startX = 0, startY = 0, startTime = 0;
        const SWIPE_THRESHOLD = 50; const TAP_THRESHOLD = 10; 
        const handleStart = (x, y) => { startX = x; startY = y; startTime = Date.now(); };
        const handleEnd = (x, y, target) => {
            if (target.closest('input') || target.closest('button') || target.closest('.logo-upload-preview') || document.getElementById('cropper-modal').contains(target)) return;
            const diffX = x - startX; const diffY = y - startY; const absDiffX = Math.abs(diffX); const absDiffY = Math.abs(diffY);
            if (absDiffX > SWIPE_THRESHOLD && absDiffX > absDiffY) { if (diffX > 0) cycleCard(-1); else cycleCard(1); } 
            else if (absDiffX < TAP_THRESHOLD && absDiffY < TAP_THRESHOLD) { playWhistle(); }
        };

        cardDisplay.addEventListener('touchstart', (e) => handleStart(e.changedTouches[0].screenX, e.changedTouches[0].screenY), { passive: false });
        cardDisplay.addEventListener('touchend', (e) => handleEnd(e.changedTouches[0].screenX, e.changedTouches[0].screenY, e.target), { passive: false });
        cardDisplay.addEventListener('mousedown', (e) => handleStart(e.screenX, e.screenY));
        cardDisplay.addEventListener('mouseup', (e) => handleEnd(e.screenX, e.screenY, e.target));
        window.addEventListener('contextmenu', event => event.preventDefault());
    </script>
</body>
</html>
